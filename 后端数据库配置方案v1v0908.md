# å¾Œç«¯æ•¸æ“šåº«é…ç½®æ–¹æ¡ˆ v1.0908

## ğŸ¯ æ•¸æ“šåº«æ¶æ§‹è¨­è¨ˆ

### ç•¶å‰ç‹€æ³åˆ†æ
```
ğŸ“Š å‰ç«¯æ•¸æ“šåº«é…ç½® (éœ€è¦é·ç§»):
- ä¸»æ©Ÿåœ°å€: mysql.zeabur.internal
- æ•¸æ“šåº«å: zeabur
- ç”¨æˆ¶å: root
- å¯†ç¢¼: fhlkzgNuRQL79C5eFb4036vX2T18YdAn
- ç«¯å£: 3306
- å­—ç¬¦é›†: utf8mb4
```

### å¾Œç«¯æ•¸æ“šåº«é…ç½®å»ºè­°

#### é¸é …1: ä½¿ç”¨ç¾æœ‰ZEABUR MySQL (æ¨è–¦)
```bash
# å¾Œç«¯ç’°å¢ƒè®Šé‡é…ç½®
DB_CONNECTION=mysql
DB_HOST=mysql.zeabur.internal
DB_PORT=3306
DB_DATABASE=nocode_architects_backend
DB_USERNAME=root
DB_PASSWORD=fhlkzgNuRQL79C5eFb4036vX2T18YdAn
DB_CHARSET=utf8mb4
DB_COLLATION=utf8mb4_unicode_ci
DB_PREFIX=nca_

# é€£æ¥æ± é…ç½®
DB_POOL_MIN=2
DB_POOL_MAX=10
DB_TIMEOUT=30000
```

#### é¸é …2: æ–°å»ºç¨ç«‹å¾Œç«¯æ•¸æ“šåº«
```bash
# å¦‚æœéœ€è¦å®Œå…¨ç¨ç«‹çš„æ•¸æ“šåº«
DB_HOST=backend-mysql.zeabur.internal
DB_DATABASE=no_code_architects_backend
DB_USERNAME=backend_user
DB_PASSWORD=æ–°çš„å¼·å¯†ç¢¼
```

## ğŸ—ƒï¸ æ•¸æ“šåº«è¡¨çµæ§‹è¨­è¨ˆ

### æ ¸å¿ƒè¡¨çµæ§‹

#### 1. ç”¨æˆ¶ç®¡ç†è¡¨
```sql
-- ç”¨æˆ¶è¡¨
CREATE TABLE `nca_users` (
  `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
  `uuid` varchar(36) NOT NULL COMMENT 'ç”¨æˆ¶å”¯ä¸€æ¨™è­˜',
  `username` varchar(50) NOT NULL COMMENT 'ç”¨æˆ¶å',
  `email` varchar(100) NOT NULL COMMENT 'éƒµç®±',
  `phone` varchar(20) DEFAULT NULL COMMENT 'æ‰‹æ©Ÿè™Ÿ',
  `password_hash` varchar(255) NOT NULL COMMENT 'å¯†ç¢¼å“ˆå¸Œ',
  `avatar_url` varchar(500) DEFAULT NULL COMMENT 'é ­åƒURL',
  `status` tinyint(1) DEFAULT 1 COMMENT 'ç‹€æ…‹ 1-æ­£å¸¸ 0-ç¦ç”¨',
  `api_key` varchar(64) DEFAULT NULL COMMENT 'ç”¨æˆ¶APIå¯†é‘°',
  `api_quota` int(10) DEFAULT 100 COMMENT 'APIèª¿ç”¨é…é¡',
  `api_used` int(10) DEFAULT 0 COMMENT 'å·²ä½¿ç”¨é…é¡',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_uuid` (`uuid`),
  UNIQUE KEY `uk_email` (`email`),
  KEY `idx_username` (`username`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ¶è¡¨';
```

#### 2. GenHumané …ç›®ç®¡ç†è¡¨
```sql
-- GenHumané …ç›®è¡¨
CREATE TABLE `nca_genhuman_projects` (
  `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
  `uuid` varchar(36) NOT NULL COMMENT 'é …ç›®å”¯ä¸€æ¨™è­˜',
  `user_id` bigint(20) UNSIGNED NOT NULL COMMENT 'ç”¨æˆ¶ID',
  `project_name` varchar(200) NOT NULL COMMENT 'é …ç›®åç¨±',
  `project_type` enum('voice_clone','digital_human','text_to_speech') NOT NULL COMMENT 'é …ç›®é¡å‹',
  `description` text COMMENT 'é …ç›®æè¿°',
  `status` enum('pending','processing','completed','failed','cancelled') DEFAULT 'pending' COMMENT 'é …ç›®ç‹€æ…‹',
  `priority` tinyint(1) DEFAULT 5 COMMENT 'å„ªå…ˆç´š 1-10',
  `config_json` json COMMENT 'é …ç›®é…ç½®JSON',
  `result_data` json COMMENT 'çµæœæ•¸æ“šJSON',
  `error_message` text COMMENT 'éŒ¯èª¤ä¿¡æ¯',
  `progress` tinyint(3) DEFAULT 0 COMMENT 'é€²åº¦ç™¾åˆ†æ¯” 0-100',
  `estimated_time` int(10) DEFAULT NULL COMMENT 'é ä¼°æ™‚é–“(ç§’)',
  `actual_time` int(10) DEFAULT NULL COMMENT 'å¯¦éš›æ™‚é–“(ç§’)',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `completed_at` timestamp NULL DEFAULT NULL COMMENT 'å®Œæˆæ™‚é–“',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_uuid` (`uuid`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_project_type` (`project_type`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  FOREIGN KEY (`user_id`) REFERENCES `nca_users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='GenHumané …ç›®è¡¨';
```

#### 3. æ–‡ä»¶ç®¡ç†è¡¨
```sql
-- æ–‡ä»¶ç®¡ç†è¡¨
CREATE TABLE `nca_files` (
  `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
  `uuid` varchar(36) NOT NULL COMMENT 'æ–‡ä»¶å”¯ä¸€æ¨™è­˜',
  `user_id` bigint(20) UNSIGNED NOT NULL COMMENT 'ç”¨æˆ¶ID',
  `project_id` bigint(20) UNSIGNED DEFAULT NULL COMMENT 'é—œè¯é …ç›®ID',
  `file_name` varchar(255) NOT NULL COMMENT 'åŸå§‹æ–‡ä»¶å',
  `file_type` enum('audio','video','image','text','result') NOT NULL COMMENT 'æ–‡ä»¶é¡å‹',
  `mime_type` varchar(100) NOT NULL COMMENT 'MIMEé¡å‹',
  `file_size` bigint(20) NOT NULL COMMENT 'æ–‡ä»¶å¤§å°(å­—ç¯€)',
  `file_path` varchar(500) NOT NULL COMMENT 'æ–‡ä»¶å­˜å„²è·¯å¾‘',
  `file_url` varchar(500) NOT NULL COMMENT 'æ–‡ä»¶è¨ªå•URL',
  `file_hash` varchar(64) DEFAULT NULL COMMENT 'æ–‡ä»¶å“ˆå¸Œå€¼',
  `duration` decimal(10,2) DEFAULT NULL COMMENT 'éŸ³è¦–é »æ™‚é•·(ç§’)',
  `resolution` varchar(20) DEFAULT NULL COMMENT 'è¦–é »è§£æåº¦',
  `metadata` json COMMENT 'æ–‡ä»¶å…ƒæ•¸æ“š',
  `status` enum('uploading','processing','completed','failed') DEFAULT 'uploading' COMMENT 'è™•ç†ç‹€æ…‹',
  `is_temporary` tinyint(1) DEFAULT 0 COMMENT 'æ˜¯å¦è‡¨æ™‚æ–‡ä»¶',
  `expires_at` timestamp NULL DEFAULT NULL COMMENT 'éæœŸæ™‚é–“',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_uuid` (`uuid`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_project_id` (`project_id`),
  KEY `idx_file_type` (`file_type`),
  KEY `idx_status` (`status`),
  KEY `idx_is_temporary` (`is_temporary`),
  KEY `idx_expires_at` (`expires_at`),
  FOREIGN KEY (`user_id`) REFERENCES `nca_users` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`project_id`) REFERENCES `nca_genhuman_projects` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ–‡ä»¶ç®¡ç†è¡¨';
```

#### 4. GenHuman APIèª¿ç”¨è¨˜éŒ„è¡¨
```sql
-- GenHuman APIèª¿ç”¨è¨˜éŒ„è¡¨
CREATE TABLE `nca_api_calls` (
  `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
  `uuid` varchar(36) NOT NULL COMMENT 'èª¿ç”¨å”¯ä¸€æ¨™è­˜',
  `user_id` bigint(20) UNSIGNED NOT NULL COMMENT 'ç”¨æˆ¶ID',
  `project_id` bigint(20) UNSIGNED DEFAULT NULL COMMENT 'é—œè¯é …ç›®ID',
  `api_endpoint` varchar(200) NOT NULL COMMENT 'APIç«¯é»',
  `api_method` enum('GET','POST','PUT','DELETE') NOT NULL COMMENT 'HTTPæ–¹æ³•',
  `request_data` json COMMENT 'è«‹æ±‚æ•¸æ“š',
  `response_data` json COMMENT 'éŸ¿æ‡‰æ•¸æ“š',
  `response_code` int(3) NOT NULL COMMENT 'HTTPç‹€æ…‹ç¢¼',
  `response_time` int(10) NOT NULL COMMENT 'éŸ¿æ‡‰æ™‚é–“(æ¯«ç§’)',
  `success` tinyint(1) NOT NULL COMMENT 'æ˜¯å¦æˆåŠŸ',
  `error_message` text COMMENT 'éŒ¯èª¤ä¿¡æ¯',
  `retry_count` tinyint(2) DEFAULT 0 COMMENT 'é‡è©¦æ¬¡æ•¸',
  `ip_address` varchar(45) DEFAULT NULL COMMENT 'è«‹æ±‚IP',
  `user_agent` varchar(500) DEFAULT NULL COMMENT 'ç”¨æˆ¶ä»£ç†',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_uuid` (`uuid`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_project_id` (`project_id`),
  KEY `idx_api_endpoint` (`api_endpoint`),
  KEY `idx_success` (`success`),
  KEY `idx_created_at` (`created_at`),
  FOREIGN KEY (`user_id`) REFERENCES `nca_users` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`project_id`) REFERENCES `nca_genhuman_projects` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='APIèª¿ç”¨è¨˜éŒ„è¡¨';
```

#### 5. ç³»çµ±é…ç½®è¡¨
```sql
-- ç³»çµ±é…ç½®è¡¨
CREATE TABLE `nca_system_config` (
  `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT,
  `config_key` varchar(100) NOT NULL COMMENT 'é…ç½®éµ',
  `config_value` text NOT NULL COMMENT 'é…ç½®å€¼',
  `config_type` enum('string','integer','boolean','json') DEFAULT 'string' COMMENT 'é…ç½®é¡å‹',
  `description` varchar(500) DEFAULT NULL COMMENT 'é…ç½®æè¿°',
  `is_public` tinyint(1) DEFAULT 0 COMMENT 'æ˜¯å¦å…¬é–‹é…ç½®',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç³»çµ±é…ç½®è¡¨';
```

## ğŸ”§ Flaskæ•¸æ“šåº«é…ç½®

### 1. SQLAlchemyé…ç½®
```python
# config/database.py
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.declarative import declarative_base

class DatabaseConfig:
    # æ•¸æ“šåº«é€£æ¥é…ç½®
    DB_HOST = os.getenv('DB_HOST', 'mysql.zeabur.internal')
    DB_PORT = os.getenv('DB_PORT', '3306')
    DB_DATABASE = os.getenv('DB_DATABASE', 'nocode_architects_backend')
    DB_USERNAME = os.getenv('DB_USERNAME', 'root')
    DB_PASSWORD = os.getenv('DB_PASSWORD', 'fhlkzgNuRQL79C5eFb4036vX2T18YdAn')
    DB_CHARSET = os.getenv('DB_CHARSET', 'utf8mb4')
    
    # SQLAlchemyé…ç½®
    SQLALCHEMY_DATABASE_URI = f"mysql+pymysql://{DB_USERNAME}:{DB_PASSWORD}@{DB_HOST}:{DB_PORT}/{DB_DATABASE}?charset={DB_CHARSET}"
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_POOL_SIZE = 10
    SQLALCHEMY_POOL_TIMEOUT = 30
    SQLALCHEMY_POOL_RECYCLE = 3600
    SQLALCHEMY_MAX_OVERFLOW = 20

# æ•¸æ“šåº«é€£æ¥åˆå§‹åŒ–
engine = create_engine(
    DatabaseConfig.SQLALCHEMY_DATABASE_URI,
    pool_size=DatabaseConfig.SQLALCHEMY_POOL_SIZE,
    pool_timeout=DatabaseConfig.SQLALCHEMY_POOL_TIMEOUT,
    pool_recycle=DatabaseConfig.SQLALCHEMY_POOL_RECYCLE,
    max_overflow=DatabaseConfig.SQLALCHEMY_MAX_OVERFLOW,
    echo=False  # ç”Ÿç”¢ç’°å¢ƒè¨­ç‚ºFalse
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

def get_db():
    """ç²å–æ•¸æ“šåº«æœƒè©±"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

### 2. æ•¸æ“šæ¨¡å‹å®šç¾©
```python
# models/user.py
from sqlalchemy import Column, BigInteger, String, Integer, Text, TIMESTAMP, JSON
from sqlalchemy.sql import func
from config.database import Base

class User(Base):
    __tablename__ = 'nca_users'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    uuid = Column(String(36), unique=True, nullable=False)
    username = Column(String(50), nullable=False)
    email = Column(String(100), unique=True, nullable=False)
    phone = Column(String(20))
    password_hash = Column(String(255), nullable=False)
    avatar_url = Column(String(500))
    status = Column(Integer, default=1)
    api_key = Column(String(64))
    api_quota = Column(Integer, default=100)
    api_used = Column(Integer, default=0)
    created_at = Column(TIMESTAMP, server_default=func.now())
    updated_at = Column(TIMESTAMP, server_default=func.now(), onupdate=func.now())
```

### 3. æ•¸æ“šåº«é·ç§»è…³æœ¬
```python
# migrations/create_tables.py
from config.database import engine, Base
from models.user import User
from models.project import GenHumanProject
from models.file import File
from models.api_call import ApiCall
from models.config import SystemConfig

def create_all_tables():
    """å‰µå»ºæ‰€æœ‰æ•¸æ“šè¡¨"""
    try:
        Base.metadata.create_all(bind=engine)
        print("âœ… æ‰€æœ‰æ•¸æ“šè¡¨å‰µå»ºæˆåŠŸ")
        return True
    except Exception as e:
        print(f"âŒ æ•¸æ“šè¡¨å‰µå»ºå¤±æ•—: {e}")
        return False

def insert_default_config():
    """æ’å…¥é»˜èªé…ç½®"""
    from sqlalchemy.orm import sessionmaker
    
    Session = sessionmaker(bind=engine)
    session = Session()
    
    try:
        default_configs = [
            {
                'config_key': 'genhuman_api_base_url',
                'config_value': 'https://api.yidevs.com',
                'config_type': 'string',
                'description': 'GenHuman APIåŸºç¤URL'
            },
            {
                'config_key': 'max_file_size',
                'config_value': '100',
                'config_type': 'integer',
                'description': 'æœ€å¤§æ–‡ä»¶å¤§å°(MB)'
            },
            {
                'config_key': 'api_timeout',
                'config_value': '300',
                'config_type': 'integer',
                'description': 'APIèª¿ç”¨è¶…æ™‚æ™‚é–“(ç§’)'
            }
        ]
        
        for config in default_configs:
            existing = session.query(SystemConfig).filter_by(config_key=config['config_key']).first()
            if not existing:
                new_config = SystemConfig(**config)
                session.add(new_config)
        
        session.commit()
        print("âœ… é»˜èªé…ç½®æ’å…¥æˆåŠŸ")
        return True
    except Exception as e:
        session.rollback()
        print(f"âŒ é»˜èªé…ç½®æ’å…¥å¤±æ•—: {e}")
        return False
    finally:
        session.close()

if __name__ == "__main__":
    # åŸ·è¡Œæ•¸æ“šåº«åˆå§‹åŒ–
    create_all_tables()
    insert_default_config()
```

## ğŸš€ éƒ¨ç½²é…ç½®

### ZEABURç’°å¢ƒè®Šé‡è¨­ç½®
```bash
# æ·»åŠ åˆ°ZEABURç’°å¢ƒè®Šé‡
DB_CONNECTION=mysql
DB_HOST=mysql.zeabur.internal
DB_PORT=3306
DB_DATABASE=nocode_architects_backend
DB_USERNAME=root
DB_PASSWORD=fhlkzgNuRQL79C5eFb4036vX2T18YdAn
DB_CHARSET=utf8mb4
DB_POOL_SIZE=5
DB_POOL_TIMEOUT=30

# GenHuman APIé…ç½®
GENHUMAN_API_BASE_URL=https://api.yidevs.com
GENHUMAN_API_KEY=å¾å‰ç«¯åœ˜éšŠç²å–
GENHUMAN_API_TIMEOUT=300

# æ–‡ä»¶å­˜å„²é…ç½®
STORAGE_PATH=/app/output
MAX_FILE_SIZE=100
TEMP_FILE_CLEANUP_HOURS=24
```

## ğŸ“Š æ•¸æ“šé·ç§»è¨ˆåŠƒ

### éšæ®µ1: æ•¸æ“šåº«æº–å‚™
1. å‰µå»ºæ–°çš„æ•¸æ“šåº« `nocode_architects_backend`
2. åŸ·è¡Œè¡¨çµæ§‹å‰µå»ºè…³æœ¬
3. æ’å…¥é»˜èªé…ç½®æ•¸æ“š
4. æ¸¬è©¦æ•¸æ“šåº«é€£æ¥

### éšæ®µ2: æ•¸æ“šæ˜ å°„åˆ†æ
1. åˆ†æå‰ç«¯ç¾æœ‰æ•¸æ“šçµæ§‹
2. è¨­è¨ˆæ•¸æ“šé·ç§»æ˜ å°„é—œä¿‚
3. ç·¨å¯«æ•¸æ“šè½‰æ›è…³æœ¬
4. æ¸¬è©¦å°æ‰¹é‡æ•¸æ“šé·ç§»

### éšæ®µ3: å®Œæ•´æ•¸æ“šé·ç§»
1. åŸ·è¡Œå®Œæ•´æ•¸æ“šé·ç§»
2. é©—è­‰æ•¸æ“šå®Œæ•´æ€§
3. æ€§èƒ½æ¸¬è©¦å’Œå„ªåŒ–
4. å‚™ä»½é·ç§»å¾Œçš„æ•¸æ“š

## âš ï¸ æ³¨æ„äº‹é …

### 1. æ•¸æ“šå®‰å…¨
- æ‰€æœ‰æ•æ„Ÿæ•¸æ“šå¿…é ˆåŠ å¯†å­˜å„²
- APIå¯†é‘°ä½¿ç”¨ç’°å¢ƒè®Šé‡ç®¡ç†
- å®šæœŸå‚™ä»½æ•¸æ“šåº«

### 2. æ€§èƒ½å„ªåŒ–
- åˆç†è¨­è¨ˆç´¢å¼•
- ä½¿ç”¨é€£æ¥æ± ç®¡ç†æ•¸æ“šåº«é€£æ¥
- å¯¦æ–½æŸ¥è©¢ç·©å­˜ç­–ç•¥

### 3. å®¹éŒ¯è™•ç†
- å¯¦ç¾æ•¸æ“šåº«é€£æ¥é‡è©¦æ©Ÿåˆ¶
- è¨˜éŒ„è©³ç´°çš„éŒ¯èª¤æ—¥èªŒ
- è¨­ç½®æ•¸æ“šåº«ç›£æ§å‘Šè­¦

---

**æ–‡æª”ç‰ˆæœ¬**: v1.0908
**å‰µå»ºæ—¥æœŸ**: 2025-01-09
**ç¶­è­·äººå“¡**: å¾Œç«¯æŠ€è¡“åœ˜éšŠ




