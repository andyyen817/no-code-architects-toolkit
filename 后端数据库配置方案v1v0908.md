# 後端數據庫配置方案 v1.0908

## 🎯 數據庫架構設計

### 當前狀況分析
```
📊 前端數據庫配置 (需要遷移):
- 主機地址: mysql.zeabur.internal
- 數據庫名: zeabur
- 用戶名: root
- 密碼: fhlkzgNuRQL79C5eFb4036vX2T18YdAn
- 端口: 3306
- 字符集: utf8mb4
```

### 後端數據庫配置建議

#### 選項1: 使用現有ZEABUR MySQL (推薦)
```bash
# 後端環境變量配置
DB_CONNECTION=mysql
DB_HOST=mysql.zeabur.internal
DB_PORT=3306
DB_DATABASE=nocode_architects_backend
DB_USERNAME=root
DB_PASSWORD=fhlkzgNuRQL79C5eFb4036vX2T18YdAn
DB_CHARSET=utf8mb4
DB_COLLATION=utf8mb4_unicode_ci
DB_PREFIX=nca_

# 連接池配置
DB_POOL_MIN=2
DB_POOL_MAX=10
DB_TIMEOUT=30000
```

#### 選項2: 新建獨立後端數據庫
```bash
# 如果需要完全獨立的數據庫
DB_HOST=backend-mysql.zeabur.internal
DB_DATABASE=no_code_architects_backend
DB_USERNAME=backend_user
DB_PASSWORD=新的強密碼
```

## 🗃️ 數據庫表結構設計

### 核心表結構

#### 1. 用戶管理表
```sql
-- 用戶表
CREATE TABLE `nca_users` (
  `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
  `uuid` varchar(36) NOT NULL COMMENT '用戶唯一標識',
  `username` varchar(50) NOT NULL COMMENT '用戶名',
  `email` varchar(100) NOT NULL COMMENT '郵箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手機號',
  `password_hash` varchar(255) NOT NULL COMMENT '密碼哈希',
  `avatar_url` varchar(500) DEFAULT NULL COMMENT '頭像URL',
  `status` tinyint(1) DEFAULT 1 COMMENT '狀態 1-正常 0-禁用',
  `api_key` varchar(64) DEFAULT NULL COMMENT '用戶API密鑰',
  `api_quota` int(10) DEFAULT 100 COMMENT 'API調用配額',
  `api_used` int(10) DEFAULT 0 COMMENT '已使用配額',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_uuid` (`uuid`),
  UNIQUE KEY `uk_email` (`email`),
  KEY `idx_username` (`username`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用戶表';
```

#### 2. GenHuman項目管理表
```sql
-- GenHuman項目表
CREATE TABLE `nca_genhuman_projects` (
  `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
  `uuid` varchar(36) NOT NULL COMMENT '項目唯一標識',
  `user_id` bigint(20) UNSIGNED NOT NULL COMMENT '用戶ID',
  `project_name` varchar(200) NOT NULL COMMENT '項目名稱',
  `project_type` enum('voice_clone','digital_human','text_to_speech') NOT NULL COMMENT '項目類型',
  `description` text COMMENT '項目描述',
  `status` enum('pending','processing','completed','failed','cancelled') DEFAULT 'pending' COMMENT '項目狀態',
  `priority` tinyint(1) DEFAULT 5 COMMENT '優先級 1-10',
  `config_json` json COMMENT '項目配置JSON',
  `result_data` json COMMENT '結果數據JSON',
  `error_message` text COMMENT '錯誤信息',
  `progress` tinyint(3) DEFAULT 0 COMMENT '進度百分比 0-100',
  `estimated_time` int(10) DEFAULT NULL COMMENT '預估時間(秒)',
  `actual_time` int(10) DEFAULT NULL COMMENT '實際時間(秒)',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `completed_at` timestamp NULL DEFAULT NULL COMMENT '完成時間',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_uuid` (`uuid`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_project_type` (`project_type`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  FOREIGN KEY (`user_id`) REFERENCES `nca_users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='GenHuman項目表';
```

#### 3. 文件管理表
```sql
-- 文件管理表
CREATE TABLE `nca_files` (
  `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
  `uuid` varchar(36) NOT NULL COMMENT '文件唯一標識',
  `user_id` bigint(20) UNSIGNED NOT NULL COMMENT '用戶ID',
  `project_id` bigint(20) UNSIGNED DEFAULT NULL COMMENT '關聯項目ID',
  `file_name` varchar(255) NOT NULL COMMENT '原始文件名',
  `file_type` enum('audio','video','image','text','result') NOT NULL COMMENT '文件類型',
  `mime_type` varchar(100) NOT NULL COMMENT 'MIME類型',
  `file_size` bigint(20) NOT NULL COMMENT '文件大小(字節)',
  `file_path` varchar(500) NOT NULL COMMENT '文件存儲路徑',
  `file_url` varchar(500) NOT NULL COMMENT '文件訪問URL',
  `file_hash` varchar(64) DEFAULT NULL COMMENT '文件哈希值',
  `duration` decimal(10,2) DEFAULT NULL COMMENT '音視頻時長(秒)',
  `resolution` varchar(20) DEFAULT NULL COMMENT '視頻解析度',
  `metadata` json COMMENT '文件元數據',
  `status` enum('uploading','processing','completed','failed') DEFAULT 'uploading' COMMENT '處理狀態',
  `is_temporary` tinyint(1) DEFAULT 0 COMMENT '是否臨時文件',
  `expires_at` timestamp NULL DEFAULT NULL COMMENT '過期時間',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_uuid` (`uuid`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_project_id` (`project_id`),
  KEY `idx_file_type` (`file_type`),
  KEY `idx_status` (`status`),
  KEY `idx_is_temporary` (`is_temporary`),
  KEY `idx_expires_at` (`expires_at`),
  FOREIGN KEY (`user_id`) REFERENCES `nca_users` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`project_id`) REFERENCES `nca_genhuman_projects` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件管理表';
```

#### 4. GenHuman API調用記錄表
```sql
-- GenHuman API調用記錄表
CREATE TABLE `nca_api_calls` (
  `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
  `uuid` varchar(36) NOT NULL COMMENT '調用唯一標識',
  `user_id` bigint(20) UNSIGNED NOT NULL COMMENT '用戶ID',
  `project_id` bigint(20) UNSIGNED DEFAULT NULL COMMENT '關聯項目ID',
  `api_endpoint` varchar(200) NOT NULL COMMENT 'API端點',
  `api_method` enum('GET','POST','PUT','DELETE') NOT NULL COMMENT 'HTTP方法',
  `request_data` json COMMENT '請求數據',
  `response_data` json COMMENT '響應數據',
  `response_code` int(3) NOT NULL COMMENT 'HTTP狀態碼',
  `response_time` int(10) NOT NULL COMMENT '響應時間(毫秒)',
  `success` tinyint(1) NOT NULL COMMENT '是否成功',
  `error_message` text COMMENT '錯誤信息',
  `retry_count` tinyint(2) DEFAULT 0 COMMENT '重試次數',
  `ip_address` varchar(45) DEFAULT NULL COMMENT '請求IP',
  `user_agent` varchar(500) DEFAULT NULL COMMENT '用戶代理',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_uuid` (`uuid`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_project_id` (`project_id`),
  KEY `idx_api_endpoint` (`api_endpoint`),
  KEY `idx_success` (`success`),
  KEY `idx_created_at` (`created_at`),
  FOREIGN KEY (`user_id`) REFERENCES `nca_users` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`project_id`) REFERENCES `nca_genhuman_projects` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='API調用記錄表';
```

#### 5. 系統配置表
```sql
-- 系統配置表
CREATE TABLE `nca_system_config` (
  `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT,
  `config_key` varchar(100) NOT NULL COMMENT '配置鍵',
  `config_value` text NOT NULL COMMENT '配置值',
  `config_type` enum('string','integer','boolean','json') DEFAULT 'string' COMMENT '配置類型',
  `description` varchar(500) DEFAULT NULL COMMENT '配置描述',
  `is_public` tinyint(1) DEFAULT 0 COMMENT '是否公開配置',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系統配置表';
```

## 🔧 Flask數據庫配置

### 1. SQLAlchemy配置
```python
# config/database.py
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.declarative import declarative_base

class DatabaseConfig:
    # 數據庫連接配置
    DB_HOST = os.getenv('DB_HOST', 'mysql.zeabur.internal')
    DB_PORT = os.getenv('DB_PORT', '3306')
    DB_DATABASE = os.getenv('DB_DATABASE', 'nocode_architects_backend')
    DB_USERNAME = os.getenv('DB_USERNAME', 'root')
    DB_PASSWORD = os.getenv('DB_PASSWORD', 'fhlkzgNuRQL79C5eFb4036vX2T18YdAn')
    DB_CHARSET = os.getenv('DB_CHARSET', 'utf8mb4')
    
    # SQLAlchemy配置
    SQLALCHEMY_DATABASE_URI = f"mysql+pymysql://{DB_USERNAME}:{DB_PASSWORD}@{DB_HOST}:{DB_PORT}/{DB_DATABASE}?charset={DB_CHARSET}"
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_POOL_SIZE = 10
    SQLALCHEMY_POOL_TIMEOUT = 30
    SQLALCHEMY_POOL_RECYCLE = 3600
    SQLALCHEMY_MAX_OVERFLOW = 20

# 數據庫連接初始化
engine = create_engine(
    DatabaseConfig.SQLALCHEMY_DATABASE_URI,
    pool_size=DatabaseConfig.SQLALCHEMY_POOL_SIZE,
    pool_timeout=DatabaseConfig.SQLALCHEMY_POOL_TIMEOUT,
    pool_recycle=DatabaseConfig.SQLALCHEMY_POOL_RECYCLE,
    max_overflow=DatabaseConfig.SQLALCHEMY_MAX_OVERFLOW,
    echo=False  # 生產環境設為False
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

def get_db():
    """獲取數據庫會話"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

### 2. 數據模型定義
```python
# models/user.py
from sqlalchemy import Column, BigInteger, String, Integer, Text, TIMESTAMP, JSON
from sqlalchemy.sql import func
from config.database import Base

class User(Base):
    __tablename__ = 'nca_users'
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    uuid = Column(String(36), unique=True, nullable=False)
    username = Column(String(50), nullable=False)
    email = Column(String(100), unique=True, nullable=False)
    phone = Column(String(20))
    password_hash = Column(String(255), nullable=False)
    avatar_url = Column(String(500))
    status = Column(Integer, default=1)
    api_key = Column(String(64))
    api_quota = Column(Integer, default=100)
    api_used = Column(Integer, default=0)
    created_at = Column(TIMESTAMP, server_default=func.now())
    updated_at = Column(TIMESTAMP, server_default=func.now(), onupdate=func.now())
```

### 3. 數據庫遷移腳本
```python
# migrations/create_tables.py
from config.database import engine, Base
from models.user import User
from models.project import GenHumanProject
from models.file import File
from models.api_call import ApiCall
from models.config import SystemConfig

def create_all_tables():
    """創建所有數據表"""
    try:
        Base.metadata.create_all(bind=engine)
        print("✅ 所有數據表創建成功")
        return True
    except Exception as e:
        print(f"❌ 數據表創建失敗: {e}")
        return False

def insert_default_config():
    """插入默認配置"""
    from sqlalchemy.orm import sessionmaker
    
    Session = sessionmaker(bind=engine)
    session = Session()
    
    try:
        default_configs = [
            {
                'config_key': 'genhuman_api_base_url',
                'config_value': 'https://api.yidevs.com',
                'config_type': 'string',
                'description': 'GenHuman API基礎URL'
            },
            {
                'config_key': 'max_file_size',
                'config_value': '100',
                'config_type': 'integer',
                'description': '最大文件大小(MB)'
            },
            {
                'config_key': 'api_timeout',
                'config_value': '300',
                'config_type': 'integer',
                'description': 'API調用超時時間(秒)'
            }
        ]
        
        for config in default_configs:
            existing = session.query(SystemConfig).filter_by(config_key=config['config_key']).first()
            if not existing:
                new_config = SystemConfig(**config)
                session.add(new_config)
        
        session.commit()
        print("✅ 默認配置插入成功")
        return True
    except Exception as e:
        session.rollback()
        print(f"❌ 默認配置插入失敗: {e}")
        return False
    finally:
        session.close()

if __name__ == "__main__":
    # 執行數據庫初始化
    create_all_tables()
    insert_default_config()
```

## 🚀 部署配置

### ZEABUR環境變量設置
```bash
# 添加到ZEABUR環境變量
DB_CONNECTION=mysql
DB_HOST=mysql.zeabur.internal
DB_PORT=3306
DB_DATABASE=nocode_architects_backend
DB_USERNAME=root
DB_PASSWORD=fhlkzgNuRQL79C5eFb4036vX2T18YdAn
DB_CHARSET=utf8mb4
DB_POOL_SIZE=5
DB_POOL_TIMEOUT=30

# GenHuman API配置
GENHUMAN_API_BASE_URL=https://api.yidevs.com
GENHUMAN_API_KEY=從前端團隊獲取
GENHUMAN_API_TIMEOUT=300

# 文件存儲配置
STORAGE_PATH=/app/output
MAX_FILE_SIZE=100
TEMP_FILE_CLEANUP_HOURS=24
```

## 📊 數據遷移計劃

### 階段1: 數據庫準備
1. 創建新的數據庫 `nocode_architects_backend`
2. 執行表結構創建腳本
3. 插入默認配置數據
4. 測試數據庫連接

### 階段2: 數據映射分析
1. 分析前端現有數據結構
2. 設計數據遷移映射關係
3. 編寫數據轉換腳本
4. 測試小批量數據遷移

### 階段3: 完整數據遷移
1. 執行完整數據遷移
2. 驗證數據完整性
3. 性能測試和優化
4. 備份遷移後的數據

## ⚠️ 注意事項

### 1. 數據安全
- 所有敏感數據必須加密存儲
- API密鑰使用環境變量管理
- 定期備份數據庫

### 2. 性能優化
- 合理設計索引
- 使用連接池管理數據庫連接
- 實施查詢緩存策略

### 3. 容錯處理
- 實現數據庫連接重試機制
- 記錄詳細的錯誤日誌
- 設置數據庫監控告警

---

**文檔版本**: v1.0908
**創建日期**: 2025-01-09
**維護人員**: 後端技術團隊




