<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFmpegåŠŸèƒ½æµ‹è¯•ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .response-container {
            max-height: 300px;
            overflow-y: auto;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .metadata-tree {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ¬ FFmpegåŠŸèƒ½æµ‹è¯•ä¸­å¿ƒ</h1>
            <p class="text-gray-600">æµ‹è¯•FFmpegçš„å„é¡¹éŸ³è§†é¢‘å¤„ç†åŠŸèƒ½</p>
            
            <!-- å¥åº·æ£€æŸ¥ -->
            <div class="mt-4">
                <button onclick="checkHealth()" 
                        class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    ğŸ” æ£€æŸ¥FFmpegçŠ¶æ€
                </button>
                <div id="healthResult" class="mt-2"></div>
            </div>
        </div>

        <!-- åŠŸèƒ½æµ‹è¯•åŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- æ ¼å¼è½¬æ¢æµ‹è¯• -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ”„ æ ¼å¼è½¬æ¢æµ‹è¯•</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©æ–‡ä»¶:</label>
                        <input type="file" id="convertFile" accept=".mp4,.avi,.mov,.mp3,.wav,.m4a,.flac" 
                               class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ ‡æ ¼å¼:</label>
                        <select id="targetFormat" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="mp4">MP4 (è§†é¢‘)</option>
                            <option value="avi">AVI (è§†é¢‘)</option>
                            <option value="mov">MOV (è§†é¢‘)</option>
                            <option value="mp3">MP3 (éŸ³é¢‘)</option>
                            <option value="wav">WAV (éŸ³é¢‘)</option>
                            <option value="m4a">M4A (éŸ³é¢‘)</option>
                            <option value="flac">FLAC (éŸ³é¢‘)</option>
                        </select>
                    </div>
                    <button onclick="testFormatConvert()" 
                            class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        ğŸ”„ å¼€å§‹è½¬æ¢
                    </button>
                    <div id="convertResult" class="response-container"></div>
                </div>
            </div>

            <!-- å…ƒæ•°æ®è·å–æµ‹è¯• -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ“Š å…ƒæ•°æ®è·å–æµ‹è¯•</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©åª’ä½“æ–‡ä»¶:</label>
                        <input type="file" id="metadataFile" accept=".mp4,.avi,.mov,.mp3,.wav,.m4a,.flac,.mkv" 
                               class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <button onclick="testGetMetadata()" 
                            class="w-full bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                        ğŸ“Š è·å–å…ƒæ•°æ®
                    </button>
                    <div id="metadataResult" class="response-container"></div>
                </div>
            </div>

            <!-- åª’ä½“å‰ªåˆ‡æµ‹è¯• -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">âœ‚ï¸ åª’ä½“å‰ªåˆ‡æµ‹è¯•</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©åª’ä½“æ–‡ä»¶:</label>
                        <input type="file" id="trimFile" accept=".mp4,.avi,.mov,.mp3,.wav,.m4a,.flac" 
                               class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¼€å§‹æ—¶é—´ (ç§’):</label>
                            <input type="number" id="startTime" value="0" min="0" step="0.1"
                                   class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æŒç»­æ—¶é—´ (ç§’):</label>
                            <input type="number" id="duration" value="10" min="0.1" step="0.1"
                                   class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <button onclick="testTrimMedia()" 
                            class="w-full bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded">
                        âœ‚ï¸ å¼€å§‹å‰ªåˆ‡
                    </button>
                    <div id="trimResult" class="response-container"></div>
                </div>
            </div>

            <!-- æ–‡ä»¶ç®¡ç† -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ—‚ï¸ æ–‡ä»¶ç®¡ç†</h2>
                <div class="space-y-4">
                    <button onclick="cleanupFiles()" 
                            class="w-full bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        ğŸ—‘ï¸ æ¸…ç†æµ‹è¯•æ–‡ä»¶
                    </button>
                    <div id="cleanupResult" class="response-container"></div>
                    
                    <div class="mt-4">
                        <h3 class="font-medium mb-2">ğŸ“ˆ æµ‹è¯•ç»Ÿè®¡</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-green-100 p-2 rounded">
                                <div class="font-medium">æˆåŠŸæµ‹è¯•</div>
                                <div id="successCount" class="text-xl font-bold text-green-600">0</div>
                            </div>
                            <div class="bg-red-100 p-2 rounded">
                                <div class="font-medium">å¤±è´¥æµ‹è¯•</div>
                                <div id="failureCount" class="text-xl font-bold text-red-600">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
            <div id="logContainer" class="bg-gray-50 p-4 rounded-md h-64 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
            </div>
            <div class="mt-4">
                <button onclick="clearLogs()" 
                        class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                    ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                </button>
            </div>
        </div>
    </div>

    <script>
        let successCount = 0;
        let failureCount = 0;
        const BASE_URL = '/test/nca/ffmpeg';

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `mb-1 ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-700'}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(containerId, content, isSuccess = true) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="p-3 rounded-md ${isSuccess ? 'success' : 'error'}">${content}</div>`;
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats(isSuccess) {
            if (isSuccess) {
                successCount++;
                document.getElementById('successCount').textContent = successCount;
            } else {
                failureCount++;
                document.getElementById('failureCount').textContent = failureCount;
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="text-gray-500">æ—¥å¿—å·²æ¸…ç©º...</div>';
        }

        // å¥åº·æ£€æŸ¥
        async function checkHealth() {
            try {
                log('å¼€å§‹FFmpegå¥åº·æ£€æŸ¥...');
                const response = await fetch(`${BASE_URL}/health`);
                const result = await response.json();
                
                if (result.status === 'healthy') {
                    log('âœ… FFmpegå¥åº·æ£€æŸ¥é€šè¿‡', 'success');
                    showResult('healthResult', `
                        <strong>FFmpegçŠ¶æ€: æ­£å¸¸</strong><br>
                        ç‰ˆæœ¬ä¿¡æ¯: ${result.version_info || 'æœªçŸ¥'}<br>
                        FFmpegè·¯å¾„: ${result.ffmpeg_path}<br>
                        FFprobeè·¯å¾„: ${result.ffprobe_path}<br>
                        è¾“å‡ºç›®å½•: ${result.output_dir}
                    `, true);
                } else {
                    log('âŒ FFmpegå¥åº·æ£€æŸ¥å¤±è´¥', 'error');
                    showResult('healthResult', `FFmpegä¸å¯ç”¨: ${JSON.stringify(result)}`, false);
                }
            } catch (error) {
                log(`âŒ å¥åº·æ£€æŸ¥é”™è¯¯: ${error.message}`, 'error');
                showResult('healthResult', `æ£€æŸ¥å¤±è´¥: ${error.message}`, false);
            }
        }

        // æ ¼å¼è½¬æ¢æµ‹è¯•
        async function testFormatConvert() {
            const fileInput = document.getElementById('convertFile');
            const targetFormat = document.getElementById('targetFormat').value;
            
            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©è¦è½¬æ¢çš„æ–‡ä»¶');
                return;
            }

            try {
                log(`å¼€å§‹æ ¼å¼è½¬æ¢: ${fileInput.files[0].name} -> ${targetFormat}`);
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('target_format', targetFormat);

                const startTime = Date.now();
                const response = await fetch(`${BASE_URL}/convert`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                const responseTime = Date.now() - startTime;

                if (result.success) {
                    log(`âœ… æ ¼å¼è½¬æ¢æˆåŠŸï¼Œç”¨æ—¶: ${responseTime}ms`, 'success');
                    showResult('convertResult', `
                        <strong>è½¬æ¢æˆåŠŸ!</strong><br>
                        è¾“å‡ºæ–‡ä»¶: ${result.output_file}<br>
                        æ–‡ä»¶å¤§å°: ${(result.file_size / 1024 / 1024).toFixed(2)} MB<br>
                        å¤„ç†æ—¶é—´: ${result.processing_time.toFixed(2)} ç§’<br>
                        <a href="${result.download_url}" class="text-blue-600 underline" target="_blank">ä¸‹è½½æ–‡ä»¶</a>
                    `, true);
                    updateStats(true);
                } else {
                    throw new Error(result.error || 'è½¬æ¢å¤±è´¥');
                }
            } catch (error) {
                log(`âŒ æ ¼å¼è½¬æ¢å¤±è´¥: ${error.message}`, 'error');
                showResult('convertResult', `è½¬æ¢å¤±è´¥: ${error.message}`, false);
                updateStats(false);
            }
        }

        // å…ƒæ•°æ®è·å–æµ‹è¯•
        async function testGetMetadata() {
            const fileInput = document.getElementById('metadataFile');
            
            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©åª’ä½“æ–‡ä»¶');
                return;
            }

            try {
                log(`å¼€å§‹è·å–å…ƒæ•°æ®: ${fileInput.files[0].name}`);
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                const startTime = Date.now();
                const response = await fetch(`${BASE_URL}/metadata`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                const responseTime = Date.now() - startTime;

                if (result.success) {
                    log(`âœ… å…ƒæ•°æ®è·å–æˆåŠŸï¼Œç”¨æ—¶: ${responseTime}ms`, 'success');
                    
                    // æ ¼å¼åŒ–å…ƒæ•°æ®æ˜¾ç¤º
                    const metadata = result.metadata;
                    let metadataHtml = '<strong>å…ƒæ•°æ®ä¿¡æ¯:</strong><br>';
                    
                    if (metadata.format) {
                        metadataHtml += `<br><strong>æ ¼å¼ä¿¡æ¯:</strong><br>`;
                        metadataHtml += `æ–‡ä»¶å: ${metadata.format.filename || 'N/A'}<br>`;
                        metadataHtml += `æ ¼å¼: ${metadata.format.format_name || 'N/A'}<br>`;
                        metadataHtml += `æ—¶é•¿: ${metadata.format.duration || 'N/A'} ç§’<br>`;
                        metadataHtml += `å¤§å°: ${metadata.format.size || 'N/A'} å­—èŠ‚<br>`;
                        metadataHtml += `æ¯”ç‰¹ç‡: ${metadata.format.bit_rate || 'N/A'} bps<br>`;
                    }
                    
                    if (metadata.streams && metadata.streams.length > 0) {
                        metadataHtml += `<br><strong>æµä¿¡æ¯ (${metadata.streams.length} ä¸ªæµ):</strong><br>`;
                        metadata.streams.forEach((stream, index) => {
                            metadataHtml += `<br>æµ ${index + 1} (${stream.codec_type || 'unknown'}):<br>`;
                            metadataHtml += `ç¼–è§£ç å™¨: ${stream.codec_name || 'N/A'}<br>`;
                            if (stream.codec_type === 'video') {
                                metadataHtml += `åˆ†è¾¨ç‡: ${stream.width || 'N/A'}x${stream.height || 'N/A'}<br>`;
                                metadataHtml += `å¸§ç‡: ${stream.r_frame_rate || 'N/A'}<br>`;
                            } else if (stream.codec_type === 'audio') {
                                metadataHtml += `é‡‡æ ·ç‡: ${stream.sample_rate || 'N/A'} Hz<br>`;
                                metadataHtml += `å£°é“: ${stream.channels || 'N/A'}<br>`;
                            }
                        });
                    }
                    
                    showResult('metadataResult', metadataHtml, true);
                    updateStats(true);
                } else {
                    throw new Error(result.error || 'è·å–å…ƒæ•°æ®å¤±è´¥');
                }
            } catch (error) {
                log(`âŒ å…ƒæ•°æ®è·å–å¤±è´¥: ${error.message}`, 'error');
                showResult('metadataResult', `è·å–å¤±è´¥: ${error.message}`, false);
                updateStats(false);
            }
        }

        // åª’ä½“å‰ªåˆ‡æµ‹è¯•
        async function testTrimMedia() {
            const fileInput = document.getElementById('trimFile');
            const startTime = document.getElementById('startTime').value;
            const duration = document.getElementById('duration').value;
            
            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©è¦å‰ªåˆ‡çš„åª’ä½“æ–‡ä»¶');
                return;
            }

            try {
                log(`å¼€å§‹åª’ä½“å‰ªåˆ‡: ${fileInput.files[0].name} (${startTime}s, ${duration}s)`);
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('start_time', startTime);
                formData.append('duration', duration);

                const startTimeExec = Date.now();
                const response = await fetch(`${BASE_URL}/trim`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                const responseTime = Date.now() - startTimeExec;

                if (result.success) {
                    log(`âœ… åª’ä½“å‰ªåˆ‡æˆåŠŸï¼Œç”¨æ—¶: ${responseTime}ms`, 'success');
                    showResult('trimResult', `
                        <strong>å‰ªåˆ‡æˆåŠŸ!</strong><br>
                        è¾“å‡ºæ–‡ä»¶: ${result.output_file}<br>
                        æ–‡ä»¶å¤§å°: ${(result.file_size / 1024 / 1024).toFixed(2)} MB<br>
                        å¤„ç†æ—¶é—´: ${result.processing_time.toFixed(2)} ç§’<br>
                        <a href="${result.download_url}" class="text-blue-600 underline" target="_blank">ä¸‹è½½æ–‡ä»¶</a>
                    `, true);
                    updateStats(true);
                } else {
                    throw new Error(result.error || 'å‰ªåˆ‡å¤±è´¥');
                }
            } catch (error) {
                log(`âŒ åª’ä½“å‰ªåˆ‡å¤±è´¥: ${error.message}`, 'error');
                showResult('trimResult', `å‰ªåˆ‡å¤±è´¥: ${error.message}`, false);
                updateStats(false);
            }
        }

        // æ¸…ç†æ–‡ä»¶
        async function cleanupFiles() {
            try {
                log('å¼€å§‹æ¸…ç†æµ‹è¯•æ–‡ä»¶...');
                
                const response = await fetch(`${BASE_URL}/cleanup`, {
                    method: 'POST'
                });
                
                const result = await response.json();

                if (result.success) {
                    log(`âœ… æ–‡ä»¶æ¸…ç†æˆåŠŸ: ${result.message}`, 'success');
                    showResult('cleanupResult', result.message, true);
                } else {
                    throw new Error(result.error || 'æ¸…ç†å¤±è´¥');
                }
            } catch (error) {
                log(`âŒ æ–‡ä»¶æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
                showResult('cleanupResult', `æ¸…ç†å¤±è´¥: ${error.message}`, false);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥å¥åº·çŠ¶æ€
        $(document).ready(function() {
            log('FFmpegæµ‹è¯•ä¸­å¿ƒå·²åŠ è½½');
            checkHealth();
        });
    </script>
</body>
</html>