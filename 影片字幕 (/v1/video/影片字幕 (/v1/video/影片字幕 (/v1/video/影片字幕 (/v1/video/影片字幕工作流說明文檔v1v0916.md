# 影片字幕 (/v1/video/caption) 功能詳細工作流說明文檔 v1v0916

## 概述

影片字幕功能是一個完整的視頻處理管道，能夠為視頻添加字幕。該功能支持兩種模式：
1. **手動字幕模式**：用戶提供字幕內容（SRT/ASS格式或純文本）
2. **自動轉錄模式**：系統自動識別視頻中的語音並生成字幕

## API 端點

- **生產端點**：`/v1/video/caption` (需要認證)
- **測試端點**：`/test/caption` (無需認證)

## 詳細工作流程

### 第一步：請求接收與驗證

**位置**：`routes/v1/video/caption_video.py` 或 `routes/test_caption.py`

1. **接收 HTTP POST 請求**
   - 驗證請求格式（JSON）
   - 驗證必需參數：`video_url`
   - 驗證可選參數：`captions`, `settings`, `language`, `replace`, `exclude_time_ranges`

2. **生成作業 ID**
   ```python
   job_id = str(uuid.uuid4())[:8]  # 生成8位唯一標識符
   ```

3. **參數解析**
   - `video_url`: 視頻文件的URL
   - `captions`: 字幕內容（可選）
   - `settings`: 字幕樣式設置
   - `language`: 語言設置（默認'auto'）
   - `replace`: 文本替換規則
   - `exclude_time_ranges`: 排除時間範圍

### 第二步：核心字幕生成服務調用

**位置**：`services/ass_toolkit.py` - `generate_ass_captions_v1()` 函數

#### 2.1 字體可用性檢查
```python
font_family = style_options.get('font_family', 'Arial')
available_fonts = get_available_fonts()
if font_family not in available_fonts:
    return {"error": f"Font '{font_family}' not available.", "available_fonts": available_fonts}
```

#### 2.2 字幕內容處理分支

**分支A：用戶提供字幕內容**
```python
if captions and is_url(captions):
    # 從URL下載字幕文件
    captions_content = download_captions(captions)
elif captions:
    # 直接使用提供的字幕內容
    captions_content = captions
else:
    captions_content = None  # 進入自動轉錄模式
```

**分支B：自動轉錄模式**
```python
if not captions_content:
    # 調用語音轉錄服務
    transcription_result = generate_transcription(video_path, language=language)
```

### 第三步：視頻文件下載

**位置**：`services/file_management.py` - `download_file()` 函數

```python
video_path = download_file(video_url, LOCAL_STORAGE_PATH)
logger.info(f"Job {job_id}: Video downloaded to {video_path}")
```

### 第四步：視頻分辨率檢測

**位置**：`services/ass_toolkit.py` - `get_video_resolution()` 函數

```python
if PlayResX is not None and PlayResY is not None:
    video_resolution = (PlayResX, PlayResY)
else:
    video_resolution = get_video_resolution(video_path)  # 使用FFmpeg檢測
```

### 第五步：語音轉錄（自動模式）

**位置**：`services/ass_toolkit.py` - `generate_transcription()` 函數

```python
def generate_transcription(video_path, language='auto'):
    # 使用 OpenAI Whisper small 模型
    model = whisper.load_model("small")
    
    # 執行轉錄，包含詞級時間戳
    result = model.transcribe(
        video_path, 
        language=None if language == 'auto' else language,
        word_timestamps=True
    )
    
    return result
```

**轉錄結果結構**：
```python
{
    'segments': [
        {
            'start': 0.0,
            'end': 3.5,
            'text': '轉錄的文本內容',
            'words': [...]  # 詞級時間戳
        }
    ]
}
```

### 第六步：字幕格式處理

#### 6.1 SRT 格式處理
**位置**：`services/ass_toolkit.py` - `srt_to_transcription_result()` 函數

```python
def srt_to_transcription_result(srt_content):
    subtitles = list(srt.parse(srt_content))  # 使用 srt 庫解析
    segments = []
    for sub in subtitles:
        segments.append({
            'start': sub.start.total_seconds(),
            'end': sub.end.total_seconds(),
            'text': sub.content.strip(),
            'words': []  # SRT 不提供詞級時間戳
        })
    return {'segments': segments}
```

#### 6.2 ASS 格式檢測
```python
if '[Script Info]' in captions_content:
    # 直接使用 ASS 格式
    subtitle_content = captions_content
    subtitle_type = 'ass'
else:
    # 處理為 SRT 格式
    transcription_result = srt_to_transcription_result(captions_content)
```

### 第七步：字幕樣式處理

**位置**：`services/ass_toolkit.py` - `process_subtitle_events()` 函數

#### 7.1 樣式類型確定
```python
style_type = style_options.get('style', 'classic').lower()
# 支持的樣式：classic, karaoke, highlight, underline, word_by_word
```

#### 7.2 樣式處理器調用
```python
STYLE_HANDLERS = {
    'classic': handle_classic,
    'karaoke': handle_karaoke,
    'highlight': handle_highlight,
    'underline': handle_underline,
    'word_by_word': handle_word_by_word
}

subtitle_content = process_subtitle_events(
    transcription_result, 
    style_type, 
    settings, 
    replace_dict, 
    video_resolution
)
```

### 第八步：字幕文件生成

```python
subtitle_filename = f"{job_id}.{subtitle_type}"
absolute_storage_path = os.path.abspath(LOCAL_STORAGE_PATH)
subtitle_path = os.path.join(absolute_storage_path, subtitle_filename)

with open(subtitle_path, 'w', encoding='utf-8') as f:
    f.write(subtitle_content)
```

### 第九步：視頻渲染（僅生產端點）

**位置**：`routes/v1/video/caption_video.py`

#### 9.1 FFmpeg 視頻處理
```python
# 使用相對路徑避免 Windows 路徑問題
video_dir = os.path.dirname(os.path.abspath(video_path))
rel_video = os.path.basename(video_path)
rel_ass = os.path.basename(ass_path)
rel_output = os.path.basename(output_path)

# 切換到視頻目錄執行 FFmpeg
os.chdir(video_dir)
ffmpeg.input(rel_video).output(
    rel_output,
    vf=f"subtitles={rel_ass}",
    acodec='copy'
).run(overwrite_output=True)
```

#### 9.2 雲端上傳
```python
cloud_url = upload_file(output_path)
```

### 第十步：響應返回

#### 生產端點響應
```json
{
    "job_id": "abc12345",
    "response": "https://cloud-storage-url/captioned-video.mp4",
    "message": "success"
}
```

#### 測試端點響應
```json
{
    "job_id": "test_abc12345",
    "message": "Video caption generation completed successfully",
    "status": "completed",
    "output_file": "/path/to/subtitle.ass",
    "processing_info": "詳細處理信息"
}
```

## 已知問題分析

### 問題1：無法看到字幕結果
**原因**：測試端點 `/test/caption` 只生成字幕文件，不進行視頻渲染
**解決方案**：使用生產端點 `/v1/video/caption` 獲得完整的帶字幕視頻

### 問題2：中文字幕解析錯誤
**位置**：`services/ass_toolkit.py` - `srt_to_transcription_result()` 函數
**錯誤信息**：`Expected start of a continuous match or end of input but "??????" found at characters 6-12`
**原因**：
1. SRT 解析庫對中文字符編碼處理不當
2. 中文字幕內容格式不符合標準 SRT 格式
3. 字符編碼問題（UTF-8 vs GBK）

### 問題3：'str' object has no attribute 'get' 錯誤
**位置**：可能在字幕處理或響應構建階段
**原因**：
1. 代碼期望字典對象但收到字符串
2. 錯誤處理邏輯中的類型不匹配
3. 測試端點響應構建邏輯問題

## 技術依賴

### 核心庫
- **whisper**: OpenAI Whisper 語音轉錄
- **ffmpeg-python**: 視頻處理
- **srt**: SRT 字幕解析
- **flask**: Web 框架

### 外部服務
- **雲端存儲**: 文件上傳下載
- **FFmpeg**: 視頻渲染

## 配置參數

### 字幕樣式設置
```python
settings = {
    "font_family": "Arial",
    "font_size": 24,
    "line_color": "#FFFFFF",
    "outline_color": "#000000",
    "position": "bottom_center",
    "style": "classic",
    "all_caps": False,
    "max_words_per_line": 8
}
```

### 語言支持
- **auto**: 自動檢測
- **zh**: 中文
- **en**: 英文
- 其他 Whisper 支持的語言代碼

## 性能考慮

### 處理時間
1. **視頻下載**: 取決於文件大小和網絡速度
2. **語音轉錄**: Whisper small 模型，約為視頻時長的 0.1-0.3 倍
3. **視頻渲染**: FFmpeg 處理，約為視頻時長的 0.5-2 倍

### 資源使用
- **CPU**: Whisper 轉錄需要較高 CPU 使用率
- **內存**: 視頻處理需要足夠內存
- **存儲**: 臨時文件存儲需求

## 錯誤處理機制

### 字體錯誤
```python
if font_family not in available_fonts:
    return {
        "error": f"Font '{font_family}' not available.", 
        "available_fonts": available_fonts
    }
```

### 轉錄錯誤
```python
try:
    result = model.transcribe(...)
except Exception as e:
    logger.error(f"Error in transcription: {str(e)}")
    raise
```

### FFmpeg 錯誤
```python
try:
    ffmpeg.input(rel_video).output(...).run()
except Exception as e:
    return jsonify({"error": f"FFmpeg error: {str(e)}"}), 500
```

## 日誌記錄

系統在每個關鍵步驟都有詳細的日誌記錄：
- 請求接收和參數驗證
- 視頻下載進度
- 轉錄處理狀態
- 字幕生成過程
- FFmpeg 渲染進度
- 錯誤詳情和堆棧跟踪

---

**文檔版本**: v1v0916  
**創建日期**: 2024年9月16日  
**最後更新**: 2024年9月16日